---
name: 对话记录功能实现计划
overview: 参考ChatMax的对话记录设计，在Yuichat中实现完整的对话记录功能，包括数据库存储、后端服务、前端UI组件和状态管理。
todos:
  - id: db-migration
    content: 创建数据库迁移文件，添加conversations和conversation_messages表，包括索引和RLS策略
    status: completed
  - id: conversation-service
    content: 创建conversationService.ts，实现对话的CRUD操作和消息管理功能
    status: completed
    dependencies:
      - db-migration
  - id: chat-store-extension
    content: 扩展chatStore，添加对话列表管理、创建、删除和加载功能
    status: completed
    dependencies:
      - conversation-service
  - id: history-sidebar-component
    content: 创建ConversationHistorySidebar组件，实现对话记录列表UI，包括新增、删除和选择功能
    status: completed
    dependencies:
      - chat-store-extension
  - id: chat-interface-integration
    content: 在ChatInterface中集成ConversationHistorySidebar，实现三栏布局和对话切换逻辑
    status: completed
    dependencies:
      - history-sidebar-component
  - id: auto-save-messages
    content: 实现消息自动保存到数据库，新对话标题自动生成逻辑
    status: completed
    dependencies:
      - chat-interface-integration
  - id: version-update
    content: 更新VERSION文件到1.2.13，在CHANGELOG.md中添加版本记录
    status: completed
    dependencies:
      - auto-save-messages
---

# 对话记录功能实现计划

## 概述

参考ChatMax测试对话中的对话记录设计，为Yuichat实现完整的对话记录功能。包括：

- 右侧边栏显示对话记录列表
- 每个对话显示AI问候语（截断）、时间戳和删除按钮
- "新增对话"按钮创建新会话
- 点击对话记录项加载历史对话
- 数据库持久化存储对话记录

## 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    前端层                                │
├─────────────────────────────────────────────────────────┤
│  ChatInterface (主聊天界面)                              │
│    ├── ConversationHistorySidebar (右侧边栏组件)        │
│    │     ├── 对话列表                                    │
│    │     ├── 新增对话按钮                                │
│    │     └── 删除对话功能                                │
│    └── 集成对话切换逻辑                                  │
│                                                          │
│  chatStore (状态管理)                                    │
│    ├── conversations (对话列表)                          │
│    ├── loadConversations()                              │
│    ├── createConversation()                             │
│    ├── deleteConversation()                             │
│    └── loadConversationMessages()                       │
└─────────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────────┐
│                    服务层                                │
├─────────────────────────────────────────────────────────┤
│  conversationService.ts                                  │
│    ├── listConversations()                              │
│    ├── createConversation()                             │
│    ├── deleteConversation()                             │
│    ├── loadConversation()                               │
│    └── saveConversationMessage()                        │
└─────────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────────┐
│                    数据库层                              │
├─────────────────────────────────────────────────────────┤
│  conversations 表                                        │
│    ├── id (UUID)                                        │
│    ├── knowledge_base_id (UUID)                         │
│    ├── user_id (UUID)                                   │
│    ├── title (TEXT) - AI问候语截断                      │
│    ├── created_at (TIMESTAMPTZ)                         │
│    └── updated_at (TIMESTAMPTZ)                         │
│                                                          │
│  conversation_messages 表                                │
│    ├── id (UUID)                                        │
│    ├── conversation_id (UUID)                           │
│    ├── role (TEXT) - 'user' | 'assistant'               │
│    ├── content (TEXT)                                   │
│    ├── metadata (JSONB) - citations等                   │
│    └── created_at (TIMESTAMPTZ)                         │
└─────────────────────────────────────────────────────────┘
```

## 实现步骤

### 1. 数据库迁移

创建迁移文件：`supabase/migrations/20260119000000_add_conversations_tables.sql`

- **conversations表**：存储对话会话元数据
  - `id`: UUID主键
  - `knowledge_base_id`: 关联知识库（项目隔离）
  - `user_id`: 用户ID（权限控制）
  - `title`: 对话标题（AI问候语截断，最多100字符）
  - `created_at`: 创建时间
  - `updated_at`: 更新时间

- **conversation_messages表**：存储对话消息
  - `id`: UUID主键
  - `conversation_id`: 关联对话
  - `role`: 角色（'user' | 'assistant'）
  - `content`: 消息内容
  - `metadata`: JSONB字段存储citations等信息
  - `created_at`: 创建时间

- **索引**：
  - `conversations`: idx_conversations_kb_id, idx_conversations_user_id
  - `conversation_messages`: idx_messages_conversation_id

- **RLS策略**：
  - 用户只能访问自己的对话记录
  - 通过knowledge_base_id实现项目级隔离

### 2. 服务层实现

创建 `src/services/conversationService.ts`：

- `listConversations(kbId: string)`: 获取指定知识库的对话列表（按更新时间降序）
- `createConversation(kbId: string, title: string)`: 创建新对话
- `getConversation(conversationId: string)`: 获取对话详情
- `getConversationMessages(conversationId: string)`: 获取对话消息列表
- `deleteConversation(conversationId: string)`: 删除对话（级联删除消息）
- `saveMessage(conversationId: string, role: string, content: string, metadata?: any)`: 保存消息

### 3. 状态管理扩展

更新 `src/store/chatStore.ts`：

- 添加 `conversations` 状态：存储当前知识库的对话列表
- 添加 `loadConversations(kbId: string)`: 从数据库加载对话列表
- 添加 `createNewConversation(kbId: string)`: 创建新对话并切换
- 添加 `deleteConversation(conversationId: string)`: 删除对话
- 添加 `loadConversationMessages(conversationId: string)`: 加载历史对话消息
- 修改 `newConversation()`: 调用服务创建数据库记录
- 修改消息保存逻辑：对话存在时自动保存到数据库

### 4. UI组件实现

创建 `src/components/ConversationHistorySidebar.tsx`：

- **布局**：
  - 固定宽度侧边栏（约300px）
  - 标题："对话记录"
  - "新增对话"按钮（紫色主色调，带+图标）
  - 对话列表（可滚动）

- **对话项设计**：
  - 显示截断的标题（AI问候语，最多50字符）
  - 显示时间戳（格式：YYYY-MM-DD HH:mm:ss）
  - 删除图标按钮（鼠标悬停显示）
  - 选中状态高亮（当前对话）
  - 点击加载对话历史

- **交互**：
  - 点击对话项：加载并显示历史消息
  - 点击删除：确认后删除对话
  - 点击"新增对话"：创建新对话并清空当前消息

### 5. ChatInterface集成

更新 `src/components/ChatInterface.tsx`：

- 修改布局：三栏布局（Sidebar | Chat | ConversationHistorySidebar）
- 集成ConversationHistorySidebar组件（仅在/chat路由显示）
- 发送消息时自动保存到当前对话
- 切换对话时加载历史消息
- 创建新对话时更新对话列表

### 6. 数据流优化

- **自动保存**：用户发送消息后自动保存到数据库
- **标题生成**：新对话首次收到AI回复时，使用AI回复的前50字符作为标题
- **实时更新**：创建、删除对话后立即更新列表
- **项目隔离**：对话记录按knowledge_base_id隔离，切换项目时显示对应项目的对话

## 技术细节

### 标题生成策略

参考ChatMax的实现，对话标题使用AI助手的欢迎消息截断：

1. 如果存在welcomeMessage配置，使用其前50字符
2. 否则使用第一条AI回复的前50字符
3. 如果都没有，使用"新对话"

### 时间格式

使用dayjs格式化时间戳：

- 显示格式：`YYYY-MM-DD HH:mm:ss`
- 参考ChatMax的实现，使用`stampToDateSecond`类似的工具函数

### 性能优化

- 对话列表懒加载：只加载前20条，按需加载更多
- 消息加载：按页加载历史消息（每页50条）
- 本地缓存：对话列表缓存到zustand store

## 文件清单

### 新建文件

- `supabase/migrations/20260119000000_add_conversations_tables.sql`
- `src/services/conversationService.ts`
- `src/components/ConversationHistorySidebar.tsx`

### 修改文件

- `src/store/chatStore.ts` - 扩展状态管理
- `src/components/ChatInterface.tsx` - 集成对话记录侧边栏
- `src/App.tsx` - 调整布局以支持右侧边栏

## 注意事项

1. **数据迁移**：确保现有localStorage中的对话数据可以平滑迁移
2. **权限控制**：通过RLS确保用户只能访问自己的对话
3. **项目隔离**：对话记录必须与知识库绑定，确保项目级隔离
4. **删除确认**：删除对话前显示确认对话框，防止误删
5. **错误处理**：网络错误、权限错误等需要友好的错误提示